---
title: "Examen 2 Herramientas de Ciencia de Datos I"
author: 
  - name: "Andrey González Bastos C33329"
  
date: "`r Sys.Date()`"  

format:
  html:
    self-contained: true
    toc: true
    toc_float: true
    df-print: paged
    theme: cosmo
    highlight: tango
---

#Punto 1

Cargar la base de datos y librerías

```{r, message=FALSE}
#Se cargan las librerías necesarias

library(readr)
library(readxl)
library(dplyr)
library(ggplot2)

#Se carga la base de datos corrigiendo las comas y eso de las columnas numéricas

moras <- read.csv("C:/Users/XPC/Desktop/Examen2_CA0204/data/moras.txt",
                  stringsAsFactors = FALSE,
                  header = TRUE)  

#Limpieza de comas y demás de la columna salario

moras$SALARIO <- gsub('"', '', moras$SALARIO)     
moras$SALARIO <- gsub("[^0-9,]", "", moras$SALARIO)
moras$SALARIO <- gsub(",", ".", moras$SALARIO)
moras$SALARIO <- as.numeric(moras$SALARIO)


```
#Punto 2

Resumen de los cinco números

```{r}

summary(moras$SALARIO)
summary(moras$EDAD)


```

#Punto 3

```{r, message=FALSE}

#Se crea una función para hacer ese cálculo más rápido para todas las entradas del vector 

z.scores.funcion <- function(vector){
  media = mean(vector, na.rm = TRUE)
  sd = sd(vector, na.rm = TRUE)
  z.score = (vector -media)/sd 
  return(z.score)

}

#Se le hacen las nuevas columnas al moras original  
moras <- moras %>% mutate(
z.score.salario = z.scores.funcion(moras$SALARIO),
z.score.edad = z.scores.funcion(moras$EDAD)
)

#Se comprueba que todo salió bien con un head

moras %>% head(5)


#Se hace la función para verificar rangos de z.score según la instrucción del 1.96

clasificadora.de.atipicos <- function(vector){
  resultado = ifelse(abs(vector)>1.96, "Atípico", "Normal")
  return(resultado)
}

#Se actualiza el dataframe

moras <- moras %>% mutate(
rango.z.salario = clasificadora.de.atipicos(z.score.salario),
rango.z.edad = clasificadora.de.atipicos(z.score.edad)
)

#Se hace un head pequeño para comprobar que todo salió bien

moras %>% head(5)

```

#Punto 4

```{r, message=FALSE}

#Para este punto también se opta por hacer una función

porcentaje.na <- function(vector) {
  total = length(vector)
  nas = sum(is.na(vector))
  return((nas / total) * 100)
}

#Con sapply recorremos todo sin usar for ni varas raras

sapply(moras, porcentaje.na)

```

#Punto 5

```{r, message=FALSE}

#Anteriormente se vio que solo los numéricos tienen valores faltantes, por lo que se aplica la siguiente función:

imputar.promedio <- function(x) {
  media <- mean(x, na.rm = TRUE)
  x[is.na(x)] <- media
  return(x)
}

#Se imputa el dataframe completo

moras<-moras %>% mutate(across(where(is.numeric), imputar.promedio))

#Se hace la verificación y ya todo quedó listo

colSums(is.na(moras))

```

#Punto 6 

```{r, message=FALSE}

#Para esto, será necesario hacer una función para graficar con for como en el examen pasado porque si no da navidad, entonces:


graficar.categoricas <- function(df) {
  
  # Detecta columnas categóricas automáticamente
  categoricas <- names(df)[sapply(df, function(x) is.character(x) || is.factor(x))]
  
  for (var in categoricas) {
    # Agrupa y cuenta SOLO por la columna actual
    resumen <- df %>%
      group_by(.data[[var]]) %>%
      summarise(cantidad = n(), .groups = "drop")
    
    print(resumen)  # muestra tabla resumen
    
    # Gráfico de barras
    p <- ggplot(resumen, aes(x = .data[[var]], y = cantidad, fill = .data[[var]])) +
      geom_bar(stat = "identity") +
      labs(title = paste("Distribución de", var),
           x = var,
           y = "Cantidad") +
      theme_minimal() +
      theme(legend.position = "none")
    
    print(p)  # muestra gráfico
  }
}

graficar.categoricas(moras)

```
#Punto 7

```{r, message=FALSE}

#Para esto igual hay que recurrir a un for

graficar.morosos <- function(df, indicador = "INDICADOR_MOROSO") {
  
  categoricas <- names(df)[sapply(df, function(x) is.character(x) || is.factor(x))]
  
  for (var in categoricas) {
    resumen <- df %>%
      group_by(.data[[var]]) %>%
      summarise(
        total = n(),
        morosos = sum(.data[[indicador]] %in% c("SI"), na.rm = TRUE),
        porcentaje.morosos = (morosos / total) * 100,
        .groups = "drop"
      ) %>%
      arrange(desc(porcentaje.morosos))
      print(resumen)  
    
    
    p <- ggplot(resumen, aes(x = reorder(.data[[var]], -porcentaje.morosos),
                             y = porcentaje.morosos,
                             fill = .data[[var]])) +
      geom_bar(stat = "identity") +
      labs(title = paste("Porcentaje de morosos por", var),
           x = var,
           y = "% Morosos") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "none")
    
    print(p)  # muestra gráfico
  }
}

graficar.morosos(moras)

```
#Punto 8

```{r, message=FALSE}

#Acá nuevamente se recurre a un for para recorrer todas las columnas numéricas (edad y salario)


graficar.moroso.numericas <- function(df, vars = c("EDAD", "SALARIO"), indicador = "INDICADOR_MOROSO") {
  
  for (var in vars) {
    p <- ggplot(df, aes(
      x = .data[[var]],
      fill = factor(.data[[indicador]], levels = c("NO", "SI"))
    )) +
      geom_histogram(position = "identity", alpha = 0.6, bins = 30) +
      labs(
        title = paste("Distribución de", var, "según morosidad"),
        x = var,
        y = "Cantidad",
        fill = "Moroso"
      ) +
      theme_minimal()
    
    print(p)
  }
}

graficar.moroso.numericas(moras)

```


